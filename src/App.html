<div class="App">
  <p class="App-intro">
    <svg width="{{svg.width}}" height="{{svg.height}}" ref:svg on:mousemove='onMouseMove(event)'>
        <Pythagoras w="{{baseW}}"
                    h="{{baseW}}"
                    heightFactor="{{heightFactor}}"
                    lean="{{lean}}"
                    x="{{svg.width / 2 - 40}}"
                    y="{{svg.height - baseW}}"
                    lvl="{{0}}"
                    maxlvl="{{currentMax}}"/>
    </svg>
  </p>
</div>

<script>
import { scaleLinear } from 'd3-scale'
import Pythagoras from './Pythagoras.html'

function throttleWithRAF (fn) {
  let running = false
  return function () {
    if (running) return
    running = true
    window.requestAnimationFrame(() => {
      fn.apply(this, arguments)
      running = false
    })
  }
}

const realMax = 11

export default {
  components: { Pythagoras },

  data () {
    return {
      svg: {
        width: 1280,
        height: 600
      },

      currentMax: 0,
      baseW: 80,
      heightFactor: 0,
      lean: 0
    }
  },

  oncreate () {
    this.container = this.refs.svg
    this.next()
  },

  methods: {
    next () {
      let currentMax = this.get('currentMax');
      if (currentMax < realMax) {
        currentMax += 1
        this.set({currentMax});
        setTimeout(this.next.bind(this), 100)
      }
    },

    onMouseMove (event) {
      const { left, top } = this.refs.svg.getBoundingClientRect();
      const x = event.clientX - left;
      const y = event.clientY - top;
      this.update(x, y)
    },

    update: throttleWithRAF(function (x, y) {
      const svg = this.get('svg');
      const scaleFactor = scaleLinear()
        .domain([svg.height, 0])
        .range([0, 0.8])

      const scaleLean = scaleLinear()
        .domain([0, svg.width / 2, svg.width])
        .range([0.5, 0, -0.5])

      this.set({
        heightFactor: scaleFactor(y),
        lean: scaleLean(x)
      })
    })
  }
}
</script>

<style>
.App {
  text-align: center;
}

.App-intro {
  font-size: large;
}
</style>
