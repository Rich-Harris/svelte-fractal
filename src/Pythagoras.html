<g transform="{{`translate(${x} ${y}) ${rotate}`}}">
  <rect width="{{w}}" height="{{w}}"
        x="{{0}}" y="{{0}}"
        style="fill:{{interpolateViridis(lvl/maxlvl)}}" />
  {{#if w}}
  <:Self w="{{calc.nextLeft}}"
              x="{{0}}" y="{{-nextLeft}}"
              lvl="{{lvl + 1}}" maxlvl="{{maxlvl}}"
              heightFactor="{{heightFactor}}"
              lean="{{lean}}"
              left />

  <:Self w="{{calc.nextRight}}"
              x="{{w - nextRight}}" y="{{-nextRight}}"
              lvl="{{lvl + 1}}" maxlvl="{{maxlvl}}"
              heightFactor="{{heightFactor}}"
              lean="{{lean}}"
              right />
  {{/if}}
</g>

<script>
import { interpolateViridis } from 'd3-scale'

Math.deg = radians => {
  return radians * (180 / Math.PI)
}

const memo = {}

const key = ({ w, heightFactor, lean }) => {
  return [w, heightFactor, lean].join('-')
}

const memoizedCalc = args => {
  const memoKey = key(args)

  if (memo[memoKey]) {
    return memo[memoKey]
  } else {
    const { w, heightFactor, lean } = args
    const trigH = heightFactor * w

    const result = {
      nextRight: Math.sqrt(trigH ** 2 + (w * (0.5 + lean)) ** 2),
      nextLeft: Math.sqrt(trigH ** 2 + (w * (0.5 - lean)) ** 2),
      A: Math.deg(Math.atan(trigH / ((0.5 - lean) * w))),
      B: Math.deg(Math.atan(trigH / ((0.5 + lean) * w)))
    }

    memo[memoKey] = result
    return result
  }
}

export default {
  namespace: 'svg',

  data() {
    return {
      rotate: 'rotate(0)',
      calc: {
        nextLeft: 0,
        nextRight: 0
      }
    }
  },

  computed: {
    rotate: (left, right, A, B, w, lvl, maxlvl) => {
      if (lvl >= maxlvl || w < 1) {
        return null
      }

      let rotate = ''

      if (left) {
        rotate = `rotate(${-A} 0 ${w})`
      } else if (right) {
        rotate = `rotate(${B} ${w} ${w})`
      }

      return rotate
    },

    calc: (w, heightFactor, lean, lvl, maxlvl) => {
      console.log(lvl, maxlvl, w, heightFactor)
      if (lvl >= maxlvl || w < 1) {
        return null
      }

      const { nextRight, nextLeft } = memoizedCalc({
        w: w,
        heightFactor: heightFactor,
        lean: lean
      })
      console.log(nextLeft, nextRight)

      return {
        nextRight,
        nextLeft
      }
    }
  },

  helpers: {
    interpolateViridis: interpolateViridis
  }
}
</script>
